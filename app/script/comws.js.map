{"version":3,"sources":["comws.js"],"names":["co","require","isPromise","obj","then","isGenerator","fn","constructor","name","endsWith","module","exports","mws","use","mw","push","handleError","ctx","err","mwIdx","idxErrMiddleware","length","errMiddleware","runner","wrap","process","stderr","write","run","step","idx","Promise","resolve","currentMw","next","result","Error","reject","call","res","catch"],"mappings":"AAAA,aAEA,KAAMA,IAAKC,QAAQ,SAAR,CAAX,CACMC,UAAY,SAAmBC,CAAnB,CAAwB,CACxC,MAAO,CAAC,CAACA,CAAF,GAAyB,QAAf,QAAOA,EAAP,EAA0C,UAAf,QAAOA,EAA5C,GAAuF,UAApB,QAAOA,GAAIC,IACtF,CAHD,CAKA,QAASC,YAAT,CAAqBC,CAArB,CAAyB,CACvB,MAAOA,GAAGC,WAAH,CAAeC,IAAf,CAAoBC,QAApB,CAA6B,mBAA7B,CACR,CAEDC,OAAOC,OAAP,CAAiB,KAAY,CAC3BJ,aAAc,CACZ,KAAKK,GAAL,GACD,CAEDC,IAAIC,CAAJ,CAAQ,CACN,KAAKF,GAAL,CAASG,IAAT,CAAcD,CAAd,CAED,CAEDE,YAAYC,CAAZ,CAAiBC,CAAjB,CAAsBC,CAAtB,CAA6B,KAC3B,GAAIC,GAAmBD,EAAQ,CADJ,CAGpBC,EAAmB,KAAKR,GAAL,CAASS,MAHR,EAGgB,CAEzC,KAAMC,GAAgB,KAAKV,GAAL,CAASQ,CAAT,CAAtB,CAEA,GAA6B,CAAzB,KAAcC,MAAlB,CAAgC,CAC9B,KAAME,GAASvB,GAAGwB,IAAH,CAAQF,CAAR,CAAf,CACA,MAAOC,GAAON,CAAP,CAAYC,CAAZ,CAAiB,IAAM,CAAE,CAAzB,CACR,CAEDE,GAED,CAGD,MADAK,SAAQC,MAAR,CAAeC,KAAf,CAAqBT,EAAM,IAA3B,CACA,CAAOA,CACR,CAEDU,IAAIX,CAAJ,CAAS,CAEP,KAAMY,GAAQC,CAAD,EAAS,CACpB,GAAIA,IAAQ,KAAKlB,GAAL,CAASS,MAArB,CACE,MAAOU,SAAQC,OAAR,IAAP,CAGF,KAAMC,GAAY,KAAKrB,GAAL,CAASkB,CAAT,CAAlB,CAEMI,EAAQhB,CAAD,EAAS,CACpB,GAAIA,CAAJ,CACE,MAAO,MAAKF,WAAL,CAAiBC,CAAjB,CAAsBC,CAAtB,CAA2BY,CAA3B,CAAP,CAGF,KAAMK,GAASN,EAAKC,EAAM,CAAX,CAAf,CALoB,MAOhB5B,WAAUiC,CAAV,CAPgB,CAQXA,CARW,CAWbA,YAAkBC,MAAlB,CACHL,QAAQM,MAAR,CAAeF,CAAf,CADG,CAEHJ,QAAQC,OAAR,CAAgBG,CAAhB,CACL,CAhBD,CAkBMZ,EAASlB,YAAY4B,CAAZ,EACXjC,GAAGwB,IAAH,CAAQS,CAAR,CADW,CAEXA,CApBJ,CAsBA,GAAIE,EAAJ,CAEA,GAAI,CAGAA,CAHA,CAEoB,CAAlB,KAAOd,MAFT,CAGSE,EAAON,CAAP,CAAYiB,CAAZ,CAHT,CAKSX,EAAOe,IAAP,CAAYrB,CAAZ,CAAiBiB,CAAjB,CAGZ,CAAC,MAAOhB,CAAP,CAAY,CACZ,MAAOgB,GAAKhB,CAAL,CACR,CAvCmB,MAyChBhB,WAAUiC,CAAV,CAzCgB,CA0CXA,EACJ/B,IADI,CACCmC,GAAO,CACX,MAAOA,EACR,CAHI,EAIJC,KAJI,CAIEtB,GAAO,CACZ,MAAOgB,GAAKhB,CAAL,CACR,CANI,CA1CW,CAmDba,QAAQC,OAAR,CAAgBG,CAAhB,CACR,CApDD,CAsDA,MAAON,GAAK,CAAL,CACR,CAvF0B,C","file":"comws.js","sourcesContent":["'use strict';\n\nconst co = require('./co.js');\nconst isPromise = function isPromise(obj) {\n  return !!obj && (typeof obj === 'object' || typeof obj === 'function') && typeof obj.then === 'function';\n}\n\nfunction isGenerator(fn) {\n  return fn.constructor.name.endsWith('GeneratorFunction');\n}\n\nmodule.exports = class CoMws {\n  constructor() {\n    this.mws = [];\n  }\n\n  use(mw) {\n    this.mws.push(mw);\n\n  }\n\n  handleError(ctx, err, mwIdx) {\n    let idxErrMiddleware = mwIdx + 1;\n\n    while (idxErrMiddleware < this.mws.length) {\n\n      const errMiddleware = this.mws[idxErrMiddleware];\n\n      if (errMiddleware.length === 3) {\n        const runner = co.wrap(errMiddleware);\n        return runner(ctx, err, () => {});\n      }\n\n      idxErrMiddleware++;\n\n    }\n\n    process.stderr.write(err + '\\n');\n    return err;\n  }\n\n  run(ctx) {\n\n    const step = (idx) => {\n      if (idx === this.mws.length) {\n        return Promise.resolve(true);\n      }\n\n      const currentMw = this.mws[idx];\n\n      const next = (err) => {\n        if (err) {\n          return this.handleError(ctx, err, idx);\n        }\n\n        const result = step(idx + 1);\n\n        if (isPromise(result)) {\n          return result;\n        }\n\n        return result instanceof Error\n          ? Promise.reject(result)\n          : Promise.resolve(result);\n      };\n\n      const runner = isGenerator(currentMw)\n        ? co.wrap(currentMw)\n        : currentMw;\n\n      let result;\n\n      try {\n\n        if (runner.length === 2) {\n          result = runner(ctx, next);\n        } else {\n          result = runner.call(ctx, next);\n        }\n\n      } catch (err) {\n        return next(err);\n      }\n\n      if (isPromise(result)) {\n        return result\n          .then(res => {\n            return res;\n          })\n          .catch(err => {\n            return next(err);\n          });\n      }\n\n      return Promise.resolve(result);\n    };\n\n    return step(0);\n  }\n};\n"]}