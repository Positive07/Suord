{"version":3,"sources":["co.js"],"names":["slice","Array","prototype","module","exports","co","wrap","fn","createPromise","call","apply","arguments","__generatorFunction__","gen","ctx","args","Promise","resolve","reject","onFulfilled","res","ret","next","e","onRejected","err","throw","done","value","toPromise","isPromise","then","TypeError","obj","isGeneratorFunction","isGenerator","thunkToPromise","isArray","arrayToPromise","isObject","objectToPromise","length","all","map","defer","promise","key","results","promises","push","constructor","keys","Object","i","name","displayName","val"],"mappings":"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","file":"co.js","sourcesContent":["/**\n * slice() reference.\n */\n\nvar slice = Array.prototype.slice;\n\n/**\n * Expose `co`.\n */\n\nmodule.exports = co['default'] = co.co = co;\n\n/**\n * Wrap the given generator `fn` into a\n * function that returns a promise.\n * This is a separate function so that\n * every `co()` call doesn't create a new,\n * unnecessary closure.\n *\n * @param {GeneratorFunction} fn\n * @return {Function}\n * @api public\n */\n\nco.wrap = function (fn) {\n  createPromise.__generatorFunction__ = fn;\n  return createPromise;\n  function createPromise() {\n    return co.call(this, fn.apply(this, arguments));\n  }\n};\n\n/**\n * Execute the generator function or a generator\n * and return a promise.\n *\n * @param {Function} fn\n * @return {Promise}\n * @api public\n */\n\nfunction co(gen) {\n  var ctx = this;\n  var args = slice.call(arguments, 1);\n\n  // we wrap everything in a promise to avoid promise chaining,\n  // which leads to memory leak errors.\n  // see https://github.com/tj/co/issues/180\n  return new Promise(function(resolve, reject) {\n    if (typeof gen === 'function') gen = gen.apply(ctx, args);\n    if (!gen || typeof gen.next !== 'function') return resolve(gen);\n\n    onFulfilled();\n\n    /**\n     * @param {Mixed} res\n     * @return {Promise}\n     * @api private\n     */\n\n    function onFulfilled(res) {\n      var ret;\n      try {\n        ret = gen.next(res);\n      } catch (e) {\n        return reject(e);\n      }\n      next(ret);\n      return null;\n    }\n\n    /**\n     * @param {Error} err\n     * @return {Promise}\n     * @api private\n     */\n\n    function onRejected(err) {\n      var ret;\n      try {\n        ret = gen.throw(err);\n      } catch (e) {\n        return reject(e);\n      }\n      next(ret);\n    }\n\n    /**\n     * Get the next value in the generator,\n     * return a promise.\n     *\n     * @param {Object} ret\n     * @return {Promise}\n     * @api private\n     */\n\n    function next(ret) {\n      if (ret.done) return resolve(ret.value);\n      var value = toPromise.call(ctx, ret.value);\n      if (value && isPromise(value)) return value.then(onFulfilled, onRejected);\n      return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '\n        + 'but the following object was passed: \"' + String(ret.value) + '\"'));\n    }\n  });\n}\n\n/**\n * Convert a `yield`ed value into a promise.\n *\n * @param {Mixed} obj\n * @return {Promise}\n * @api private\n */\n\nfunction toPromise(obj) {\n  if (!obj) return obj;\n  if (isPromise(obj)) return obj;\n  if (isGeneratorFunction(obj) || isGenerator(obj)) return co.call(this, obj);\n  if ('function' == typeof obj) return thunkToPromise.call(this, obj);\n  if (Array.isArray(obj)) return arrayToPromise.call(this, obj);\n  if (isObject(obj)) return objectToPromise.call(this, obj);\n  return obj;\n}\n\n/**\n * Convert a thunk to a promise.\n *\n * @param {Function}\n * @return {Promise}\n * @api private\n */\n\nfunction thunkToPromise(fn) {\n  var ctx = this;\n  return new Promise(function (resolve, reject) {\n    fn.call(ctx, function (err, res) {\n      if (err) return reject(err);\n      if (arguments.length > 2) res = slice.call(arguments, 1);\n      resolve(res);\n    });\n  });\n}\n\n/**\n * Convert an array of \"yieldables\" to a promise.\n * Uses `Promise.all()` internally.\n *\n * @param {Array} obj\n * @return {Promise}\n * @api private\n */\n\nfunction arrayToPromise(obj) {\n  return Promise.all(obj.map(toPromise, this));\n}\n\n/**\n * Convert an object of \"yieldables\" to a promise.\n * Uses `Promise.all()` internally.\n *\n * @param {Object} obj\n * @return {Promise}\n * @api private\n */\n\nfunction objectToPromise(obj){\n  var results = new obj.constructor();\n  var keys = Object.keys(obj);\n  var promises = [];\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    var promise = toPromise.call(this, obj[key]);\n    if (promise && isPromise(promise)) defer(promise, key);\n    else results[key] = obj[key];\n  }\n  return Promise.all(promises).then(function () {\n    return results;\n  });\n\n  function defer(promise, key) {\n    // predefine the key in the result\n    results[key] = undefined;\n    promises.push(promise.then(function (res) {\n      results[key] = res;\n    }));\n  }\n}\n\n/**\n * Check if `obj` is a promise.\n *\n * @param {Object} obj\n * @return {Boolean}\n * @api private\n */\n\nfunction isPromise(obj) {\n  return 'function' == typeof obj.then;\n}\n\n/**\n * Check if `obj` is a generator.\n *\n * @param {Mixed} obj\n * @return {Boolean}\n * @api private\n */\n\nfunction isGenerator(obj) {\n  return 'function' == typeof obj.next && 'function' == typeof obj.throw;\n}\n\n/**\n * Check if `obj` is a generator function.\n *\n * @param {Mixed} obj\n * @return {Boolean}\n * @api private\n */\n\nfunction isGeneratorFunction(obj) {\n  var constructor = obj.constructor;\n  if (!constructor) return false;\n  if ('GeneratorFunction' === constructor.name || 'GeneratorFunction' === constructor.displayName) return true;\n  return isGenerator(constructor.prototype);\n}\n\n/**\n * Check for plain object.\n *\n * @param {Mixed} val\n * @return {Boolean}\n * @api private\n */\n\nfunction isObject(val) {\n  return Object == val.constructor;\n}\n"]}